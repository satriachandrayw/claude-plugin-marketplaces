# CI Comment Template

This template produces JSON output for the GitHub Review API.

The output format is:
- `event`: APPROVE, REQUEST_CHANGES, or COMMENT
- `body`: The main review comment (markdown)
- `comments`: Array of line-level comments

---

## Template Variables

- `{{classification.type}}` - PR type (feature/bug-fix/refactor/chore)
- `{{classification.confidence}}` - Classification confidence percentage
- `{{impact_summary}}` - Brief impact summary
- `{{findings_counts.critical}}` - Count of critical findings
- `{{findings_counts.warning}}` - Count of warning findings
- `{{findings_counts.info}}` - Count of info findings
- `{{architectural_notes}}` - Array of architectural notes
- `{{verdict.summary}}` - Verdict summary (APPROVE/REQUEST_CHANGES/COMMENT)
- `{{verdict.recommendation}}` - Detailed recommendation
- `{{line_comments}}` - Array of line-level comments for Review API

---

## JSON Output Structure

```json
{
  "event": "{{verdict.summary}}",
  "body": "## PR Review Summary\n\n**Type:** {{classification.type}} ({{classification.confidence}}% confidence)\n\n{{impact_summary}}\n\n### Findings\n\n| Severity | Count |\n|----------|-------|\n| Critical | {{findings_counts.critical}} |\n| Warning | {{findings_counts.warning}} |\n| Info | {{findings_counts.info}} |\n\n{{#if architectural_notes.length}}\n### Architectural Notes\n\n{{#each architectural_notes}}\n- **{{type}}**: {{description}} (`{{location}}`)\n{{/each}}\n\n{{/if}}\n### Recommendation\n\n{{verdict.recommendation}}\n\n---\n*Generated by PR-Review Plugin*",
  "comments": [
    {
      "path": "{{file}}",
      "line": {{line}},
      "body": "**{{severity}}**: {{description}}\n\n**Suggestion:** {{suggestion}}"
    }
  ]
}
```

---

## Example Output (Populated)

```json
{
  "event": "REQUEST_CHANGES",
  "body": "## PR Review Summary\n\n**Type:** feature (85% confidence)\n\nChanges to auth module affect 3 callers and 2 downstream services.\n\n### Findings\n\n| Severity | Count |\n|----------|-------|\n| Critical | 1 |\n| Warning | 3 |\n| Info | 2 |\n\n### Architectural Notes\n\n- **pattern-violation**: Error handling uses throw instead of Result type pattern used elsewhere (`src/middleware/auth.ts:45`)\n- **coupling-increase**: UserController now imports 5 different services directly (`src/controllers/user-controller.ts:1-10`)\n\n### Recommendation\n\nThis PR introduces security vulnerabilities that must be addressed before merging. The SQL injection issue in `src/db/queries.ts` is critical. Additionally, please review the architectural concerns about pattern consistency.\n\n**Required Actions:**\n1. Fix SQL injection vulnerability using parameterized queries\n2. Add null checks for the new optional parameter\n3. Consider following the Result type pattern for error handling\n\n---\n*Generated by PR-Review Plugin*",
  "comments": [
    {
      "path": "src/db/queries.ts",
      "line": 45,
      "body": "**critical (sql-injection)**: User input from req.params.id is directly interpolated into SQL query string, allowing potential SQL injection attacks.\n\n**Suggestion:** Use parameterized queries with the database driver. Replace the template literal with a parameterized call like db.query('SELECT * FROM users WHERE id = $1', [req.params.id])"
    },
    {
      "path": "src/middleware/auth.ts",
      "line": 23,
      "body": "**warning (missing-auth)**: Admin route /admin/users lacks authentication middleware.\n\n**Suggestion:** Add authentication middleware before the route handler: router.get('/users', authMiddleware, getUsersHandler)"
    },
    {
      "path": "src/services/user-service.ts",
      "line": 67,
      "body": "**info (test-coverage)**: New error path for token timeout lacks test coverage.\n\n**Suggestion:** Add test case for timeout scenario"
    }
  ]
}
```

---

## Event Type Mapping

| Verdict Summary | GitHub Event |
|-----------------|--------------|
| `APPROVE` | `APPROVE` |
| `REQUEST_CHANGES` | `REQUEST_CHANGES` |
| `COMMENT` | `COMMENT` |

---

## Line Comment Format

Each line comment follows this structure:

```json
{
  "path": "relative/path/to/file.ts",
  "line": 42,
  "side": "RIGHT",
  "body": "**severity (type)**: description\n\n**Suggestion:** suggestion_text"
}
```

### Line Comment Fields

| Field | Required | Description |
|-------|----------|-------------|
| `path` | Yes | File path relative to repo root |
| `line` | Yes | Line number in the diff |
| `side` | No | `RIGHT` (new) or `LEFT` (old), defaults to RIGHT |
| `start_line` | No | For multi-line comments, start line |
| `start_side` | No | For multi-line comments, start side |
| `body` | Yes | Comment text in markdown |

---

## Conditional Sections

### Include Security Findings When Critical Count > 0

```
{{#if findings_counts.critical}}
### Critical Security Findings

This PR contains security vulnerabilities that must be addressed.
{{/if}}
```

### Include Architectural Notes When Present

```
{{#if architectural_notes.length}}
### Architectural Notes

{{#each architectural_notes}}
- **{{type}}**: {{description}}
{{/each}}
{{/if}}
```

---

## Body Template (Full)

```markdown
## PR Review Summary

**Type:** {{classification.type}} ({{classification.confidence}}% confidence)

{{impact_summary}}

### Findings

| Severity | Count |
|----------|-------|
| Critical | {{findings_counts.critical}} |
| Warning | {{findings_counts.warning}} |
| Info | {{findings_counts.info}} |

{{#if architectural_notes.length}}
### Architectural Notes

{{#each architectural_notes}}
- **{{type}}**: {{description}} (`{{location}}`)
{{/each}}

{{/if}}
### Recommendation

{{verdict.recommendation}}

---
*Generated by PR-Review Plugin*
```

---

## Usage in GitHub API

### POST Review

```bash
gh api repos/{owner}/{repo}/pulls/{pr_number}/reviews \
  -f event='{{verdict.summary}}' \
  -f body='{{rendered_body}}' \
  -f comments='{{json line_comments}}'
```

### Alternative: PR Comment

If review API is not available, post as a regular comment:

```bash
gh pr comment {pr_number} --body '{{rendered_body}}'
```

---

## Notes

- **JSON format**: The CI output must be valid JSON for API consumption
- **Markdown in body**: The `body` field supports GitHub-flavored markdown
- **Line comments**: Use the `comments` array for specific line-level feedback
- **Event type**: Determines the review status (approve/request changes/comment)
- **Truncation**: If body exceeds 64KB, summarize findings and link to details
